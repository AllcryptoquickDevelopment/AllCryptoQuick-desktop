<app-page-intro childPageAlias="Sell Templates">
  <ng-container page-title>Your Inventory &amp; Products</ng-container>
  <ng-container page-content>
    This is your dashboard for selling your Products on the marketplace and manage their Listings.<br>
    To sell, you will need to create a Product template first, which you can later publish as a Listing to any connected Market.
  </ng-container>
  <ng-container page-help>
  </ng-container>
</app-page-intro>

<!-- Listings > Filter -->
<div class="filter">

  <div class="buttons">
    <div class="button-group" fxLayout fxLayoutGap="2px" fxLayoutAlign="space-between flex-start">
      <button mat-raised-button color="primary" routerLink="new-listing" class="full-width" fxFlex="50">
        <mat-icon fontIcon="part-circle-plus"></mat-icon>
        New
      </button>
      <button mat-raised-button color="primary" routerLink="import-listings" class="full-width" fxFlex="50">
        <mat-icon fontIcon="part-image-upload"></mat-icon>
        Import
      </button>
    </div><!-- .row -->
    <button mat-raised-button color="accent" class="full-width" (click)="openBatchPublishModal()">
      <mat-icon fontIcon="part-check-2"></mat-icon>
      Batch (Re)publish&hellip;
    </button>
  </div><!-- .buttons -->

  <h2 class="section-title">
    Search &amp; sort
  </h2>

  <mat-card class="filter-card">

    <mat-form-field class="--plain" appearance="fill">
      <input matInput type="text" placeholder="Search products" [formControl]="searchQuery" (keyup.escape)="searchQuery.setValue('')">
      <button *ngIf="searchQuery.value.length > 0" matSuffix mat-button class="small" (click)="searchQuery.setValue('')" matTooltip="Clear" matTooltipPosition="after">
        <mat-icon fontIcon="part-clear-all"></mat-icon>
      </button>
      <mat-icon *ngIf="!searchQuery.value.length" matSuffix fontIcon="part-search"></mat-icon>
    </mat-form-field>

    <mat-form-field class="--plain" appearance="fill">
      <mat-select placeholder="Sort products" [formControl]="sortOrder">
        <mat-option *ngFor="let sorting of sortCriteria" [value]="sorting.value">
          {{ sorting.title }}
        </mat-option>
      </mat-select>
    </mat-form-field>

  </mat-card><!-- .filter-card -->

  <!-- <h2 class="section-title">
    Filter
  </h2> -->

  <!-- <mat-card class="filter-card">
    <mat-radio-group class="radio-group block-radio" [formControl]="filterStatus">
      <mat-radio-button class="filter-option" *ngFor="let status of filterStatusCriteria" [value]="status.value" color="accent">
        {{ status.title }}
      </mat-radio-button>
    </mat-radio-group>
  </mat-card> -->

</div><!-- .filter -->


<!-- Listings > list -->
<div class="listings section with-filter">

  <ng-container *ngIf="displayedTemplateIdxs.length > 0; else noTemplates">
    <ng-container *ngFor="let templIdx of displayedTemplateIdxs">
      <mat-expansion-panel class="product list-item no-padding" *appVar="allTemplates[templIdx] as templ">
        <mat-expansion-panel-header class="header">
          <div class="header-wrapper">
            <div class="photo">
              <img [src]="templ.images[0]">
            </div>
            <div class="meta" fxFlex="1 1 100%">
              <div class="name">{{ templ.title }}</div>
              <span class="help-text">{{ templ.summary }}</span>
            </div>
            <div class="status-wrap" fxFlex="0 0 140px">
              <div class="status --rounded">
                <span class="dot"></span>
                <span class="active">{{ templ.marketTemplates.countActiveMarkets }}</span><span class="total">/{{ templ.marketTemplates.templates.length }}</span>
              </div>
            </div>
            <mat-checkbox class="batch-select" matTooltip="Select Product" *ngIf="batchEditingActive" (click)="$event.stopPropagation()"></mat-checkbox>
          </div>
        </mat-expansion-panel-header>
        <div class="detail">
          <div class="row" fxLayout fxLayoutGap="35px" fxLayoutAlign="space-between flex-start">
            <div class="product-details" fxFlex="37">
              <h3 class="item-subtitle">Gallery</h3>
              <div class="gallery">
                <div class="image" *ngFor="let img of templ.images">
                  <img [src]="img">
                </div>
              </div>
            </div><!-- .product-details -->
            <div class="inventory-stats" fxFlex="18">
              <h3 class="item-subtitle">Inventory</h3>
              <table class="inventory">
                <!-- @TODO: until we have quantities, keep the infinity symbol -->
                <tr><th>&infin;</th><td>In stock</td></tr>
                <tr><th>{{ templ.marketTemplates.countAllListings }}</th><td>Published</td></tr>
                <!-- <tr><th>{{ templ.marketTemplates.countOrdersActive }}</th><td>In Orders</td></tr> -->
                <!-- <tr><th>{{ templ.marketTemplates.countOrdersComplete }}</th><td>Sold</td></tr> -->
              </table>
            </div><!-- .inventory-stats -->
            <div class="pricing" fxFlex="45">
              <h3 class="item-subtitle">Pricing</h3>
              <table class="prices">
                <tr>
                  <th>Product</th><td>{{templ.basePrice.whole}}<small>{{ templ.basePrice.sep }}{{ templ.basePrice.fraction }}</small> PART <span class="fiat">(&asymp; 51<small>.00</small> EUR)</span></td>
                </tr>
                <tr>
                  <th>Shipping</th>
                  <td>
                    Local ({{templ.sourceLocation}}) &ndash; {{ templ.shippingPriceLocal.whole }}<small>{{ templ.shippingPriceLocal.sep }}{{ templ.shippingPriceLocal.fraction }}</small> PART <span class="fiat">(&asymp; 2<small>.50</small> EUR)</span><br>
                    Worldwide &ndash; {{ templ.shippingPriceIntl.whole }}<small>{{ templ.shippingPriceIntl.sep }}{{ templ.shippingPriceIntl.fraction }}</small> PART <span class="fiat">(&asymp; 5<small>.46</small> EUR)</span>
                  </td>
                </tr>
              </table>
            </div><!-- .pricing -->
          </div><!-- .row -->
        </div><!-- .detail -->
        <section class="market-templates-list" *ngIf="templ.marketTemplates.templates.length > 0">
          <table class="market-templates">
            <tr>
              <th>Status</th>
              <th>Published on</th>
              <th class="category">Category</th>
              <th class="price">Price</th>
              <th class="actions">Actions</th>
            </tr>
            <tr *ngFor="let marketTempl of templ.marketTemplates.templates">
              <td>
                <span *ngIf="marketTempl.status !== null" class="status {{ marketTempl.status }} --plain" matTooltip="listing status: {{marketTempl.status}}" matTooltipPosition="before">
                  <span class="dot"></span>
                </span>
                <span class="template-name">{{ marketTempl.title }}</span>
              </td>
              <td>{{ marketTempl.marketKey }}</td>
              <td class="category">{{ marketTempl.category }}</td>
              <td class="price">{{ marketTempl.basePrice }} PART</td>
              <td class="actions">
                <button *ngIf="marketTempl.actions.edit" mat-button class="tiny icon-only" matTooltip="Edit">
                  <mat-icon fontIcon="part-pen-1"></mat-icon>
                </button>
                <button *ngIf="marketTempl.actions.clone" mat-button class="tiny icon-only" matTooltip="Clone">
                  <mat-icon fontIcon="part-copy"></mat-icon>
                </button>
                <button *ngIf="marketTempl.actions.publish" mat-button class="tiny icon-only" matTooltip="Publish" (click)="openPublishTemplateModal()">
                  <mat-icon fontIcon="part-rocket"></mat-icon>
                </button>
              </td>
            </tr>
          </table>
        </section><!-- .market-templates-list -->
        <mat-action-row class="action-buttons">
          <div class="left">
            <button *ngIf="templ.actions.delete" mat-button class="small" matTooltip="Delete Product" color="warn">
              <mat-icon fontIcon="part-cross"></mat-icon>
              Delete
            </button>
            <!-- @TODO: trigger modal with "edit template" component + append "(Copy)" to product's title input? -->
            <button *ngIf="templ.actions.clone" mat-button class="small icon-only" matTooltip="Clone Product">
              <mat-icon fontIcon="part-copy"></mat-icon>
            </button>
            <!-- @TODO: trigger modal with "edit template" component -->
            <button *ngIf="templ.actions.edit" mat-button class="small" matTooltip="Update Product">
              <mat-icon fontIcon="part-pen-1"></mat-icon>
              Edit
            </button>
            <!-- @TODO: redirect to Listings tab and filter out Listings based on this Product -->
            <button *ngIf="templ.marketTemplates.countAllListings > 0" mat-button class="small" matTooltip="Show current Listings of this Product">
              <mat-icon fontIcon="part-zoom-in"></mat-icon>
              Show Listings
            </button>
          </div>
          <div class="right">
            <!-- @TODO: remove link to BatchPublishModal (I'm using it here for dev purposes, since the batch actions menu isn't working for me) -->
            <button *ngIf="templ.actions.publish" mat-raised-button color="primary" (click)="openPublishTemplateModal()">
              <mat-icon fontIcon="part-rocket"></mat-icon>
              Publish on Market
            </button>
          </div>
        </mat-action-row>
      </mat-expansion-panel><!-- .product -->
    </ng-container>
  </ng-container>

  <ng-template #noTemplates>
    <!-- no listings at all -->
    <div class="no-results" *ngIf="allTemplates.length === 0">
      <img class="illustration" src="./assets/app-market/illustrations/no-listings.svg" alt="No Products">
      <p>
        You don't have any Products yet
      </p>
      <p class="help-text">
        Start selling by clicking on either "Add new Product" or "Import Products" button
      </p>
    </div><!-- .no-results -->

    <!-- no listings matching search -->
    <div class="no-results" *ngIf="allTemplates.length > 0">
      <img class="illustration" src="./assets/images/illustrations/search.svg" alt="No Products found">
      <p>
        No matching Products found
      </p>
      <p class="help-text">
        You don't have any Products matching your search
      </p>
    </div><!-- .no-results -->
  </ng-template>
</div><!-- .listings-list -->


<div class="loading-bar" *ngIf="isLoading">
  <mat-progress-bar mode="indeterminate" color="accent"></mat-progress-bar>
</div><!-- .loading-bar -->
